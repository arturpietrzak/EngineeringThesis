import InfiniteScrollTrigger from "~/components/InfiniteScrollTrigger";
import Head from "next/head";
import { Loader } from "~/components/Loader";
import { PostList } from "~/components/PostList";
import { api } from "~/utils/api";
import { NewPostLink } from "~/components/NewPostLink";

export default function Home() {
  const {
    data: postsData,
    refetch,
    fetchNextPage,
    isFetching,
  } = api.post.getRecent.useInfiniteQuery(
    {},
    {
      getNextPageParam: (lastPage) => lastPage.nextCursor,
    }
  );

  if (!postsData) {
    return <Loader />;
  }

  return (
    <>
      <Head>
        <title>Create T3 App</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <NewPostLink />
        <PostList
          posts={postsData.pages.map((p) => p.posts).flat(1)}
          refetch={() => {
            void refetch();
          }}
        />
        <InfiniteScrollTrigger
          isFetching={isFetching}
          onScreenEnter={fetchNextPage}
        />
      </main>
    </>
  );
}
